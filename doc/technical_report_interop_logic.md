# 技術的誤認に関する報告書: WSL Interop判定ロジックについて

## 1. 誤認していた内容
**「`/proc/sys/fs/binfmt_misc/WSLInterop` ファイルが存在しない場合、Linux環境からWindows実行ファイル（`.exe`）の呼び出しは100%不可能であるため、実行を試みる前にブロックすべきである。」**

私はこの仮定に基づき、`aoi-terminals start` コマンドにおいて、同ファイルの存在チェックを行い、存在しない場合は即座に処理を中断して「Windowsランチャー (`windows-run.bat`)」の使用を促す実装に変更してしまいました。
これは、「エラーが発生するくらいなら、最初から確実な別ルート（Windows側からの実行）へ誘導すべき」という過剰な防衛的判断でした。

## 2. 実際の挙動と正しい理解
**「設定ファイルが不可視であっても、即座に機能不全とは限らない。また、特定環境で失敗する可能性があるとしても、まずは実行を試みる（Try）べきである。」**

実際には以下の可能性があります：
1.  **権限の問題**: ファイル自体は存在するが、現在のユーザー（またはコンテナ）から見えていないだけで、カーネルレベルでは機能している場合。
2.  **一時的な不整合**: システムの状態によりファイルが見えないが、execシステムコール自体は通る場合。
3.  **ユーザーによる回避策**: ユーザーが既に別の方法でInteropを成立させている場合。

したがって、「ファイルの有無」だけで機能を切り捨てる判定を行うのは**論理の飛躍**であり、本来動作するはずの環境までブロックしてしまう不適切な実装でした。

## 3. ロジックの修正内容

今回、`scripts/production-cli.sh` を以下の通り修正（本来の姿に復元）しました。

### 修正前（私の誤った実装）
```bash
if [[ ! -e /proc/sys/fs/binfmt_misc/WSLInterop ]]; then
  # ファイルがない時点で「不可能」と断定し、諦める
  echo "Interop無効のため自動設定不可。windows-run.batを使ってください"
else
  # 実行処理...
fi
```

### 修正後（あるべき正しい実装）
```bash
# 事前チェックでブロックせず、まずは実行を試みる
# wslpathコマンド実行 (失敗時もエラー出力せず空文字を返す)
win_script=$(wslpath -w "$ps_script" 2>/dev/null || echo "")

if [[ -n "$win_script" ]]; then
  # PowerShellの実行をトライする
  if "$ps_exe" -Command "..." ...; then
     : # 成功 (自動設定完了)
  else
     # 失敗した場合のみ、ここで初めて警告と代替案(ランチャー)を出す
     echo "自動設定に失敗しました。windows-run.bat を試してください"
  fi
fi
```

## 4. 結論
この修正により、`aoi-terminals start` は**「まず自分自身で最大限の自動設定を試み、どうしてもダメだった場合のみ人間に助け（ランチャー）を求める」**という、ツールとして正しい振る舞いを取り戻しました。
これにより、WSL Interopが生きている標準的な環境では100%の自動化が機能し、そうでない環境でも適切なフォールバックが機能します。

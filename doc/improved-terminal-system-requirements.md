# 改良版Webターミナルシステム 要件定義書

## 1. プロジェクト概要

### 1.1 背景・目的
- **背景**: Nagiシステムは動作しているが、UIや認証の改善余地がある
- **目的**: Claude Code on the Webに触発された、より洗練されたWebターミナルシステムの構築
- **ターゲットユーザー**: iPad/iPhone/スマホからリモートでターミナル操作を行うユーザー（主にあおいさん個人使用）

### 1.2 成功基準
- [x] 起動ごとにランダムなログイントークンを自動発行できる（固定も可能）
- [x] スマホで手入力せずにログインできる（ワンタイム共有URL/QR）
- [x] モダンで直感的なUI（Claude Code on the Web風）
- [x] 日本語IME入力が快適に動作
- [x] 全画面モード対応で没入感のある体験を提供
- [x] tmux操作が視覚的に分かりやすい
- [x] セキュアな認証と通信

## 2. 機能要件

### 2.1 必須機能（MVP）

#### 2.1.1 認証・セキュリティ
- **二段階の前提**
  - **ネットワーク到達**: Tailscale（Tailnet / ACL）で到達できる端末を制御
  - **アプリログイン**: Webアプリとしてのログイン（Cookieセッション）を別途持つ
- **ログイントークン（起動単位）**
  - `./scripts/start.sh` 実行時に **`TERMINAL_TOKEN` が未指定ならランダム生成**し、当該起動のログイントークンとして採用
  - 固定トークン運用も可能（`TERMINAL_TOKEN=... ./scripts/start.sh`）
- **ログイン方法**
  - ブラウザでトークンを入力し、バックエンド `POST /auth` へ送信
  - バックエンドは `HttpOnly` Cookie（`its_session`）をセットし、以後は Cookie で認証
- **共有リンク（QR）**
  - **起動時**: `scripts/start.sh` や `install-docker.sh` 実行時に、**ワンタイム（5分有効）**のログイン用QRコードがコンソールに表示される（セッション24時間）
  - **共有ボタン**: ログイン済みユーザーがUIから発行できる（セッション6時間）
  - 共有トークンには **期限**がある（デフォルト 5分、`TERMINAL_LINK_TOKEN_TTL_SECONDS` で変更）
  - 共有URLは `/?token=...` 形式。ログイン成功後にURLから token を自動削除
- **セッション維持**
  - Cookieセッションの有効期間は用途により差別化:
    - **通常ログイン（起動時QR・手入力）**: **24時間**有効（自分用の長期アクセス）
    - **シェア用QR**: **6時間**有効（赤の他人に渡す短期アクセス）
  - `/link-token` APIでは `isShare` パラメータで区別:
    - `{ isShare: false }` または省略時: 24時間セッション（デフォルト、起動時スクリプトで使用）
    - `{ isShare: true }`: 6時間セッション（UIの「共有リンク発行」ボタンで使用）
  - ただし現状はバックエンドのメモリ保持のため、バックエンド再起動で失効する
- **HTTPSについて**
  - 本番で `NODE_ENV=production` の場合、Cookieに `Secure` が付与されるため **HTTPS での運用が前提**
  - TailscaleのHTTPS終端（または別途リバースプロキシ）を採用する

#### 2.1.2 ターミナル操作
- **WebSocketベース接続**
  - フロントエンド: xterm.js による描画
  - バックエンド: WebSocket（ws）で双方向通信
- **tmux統合**
  - 接続時に自動的に"work"セッションに接続
  - セッションが無ければ新規作成
- **基本的なターミナル機能**
  - 文字入力・表示
  - カーソル移動
  - カラー表示対応
  - リサイズ対応

#### 2.1.3 日本語入力（主要機能）
- **IME完全サポート**
  - xterm.jsのcompositionイベント対応
  - 変換候補表示領域の確保
  - 確定前文字の適切な表示
- **テキスト入力モーダル**（Nagi風）
  - 長文入力用の大きな入力エリア
  - ペースト後にターミナルへ送信

#### 2.1.4 UI要素
- **Claude Code on the Web風デザイン**
  - クリーンでモダンな外観
  - ダークモード対応
  - レスポンシブデザイン
- **コントロールパネル**
  - 特殊キーボタン（Ctrl, Alt, Esc, Tab, Enter）
  - 矢印キー、Home, End, PgUp, PgDn
  - ショートカットボタン（Ctrl+C, Ctrl+D, Ctrl+Z）
  - tmux操作パネル（展開式）
    - c: 新規ウィンドウ
    - n/p: 次/前のウィンドウ
    - d: デタッチ
    - %/": 縦/横分割
    - o: ペイン切替
    - z: ズーム
    - [: コピーモード

### 2.2 追加機能（Phase 2以降）

- **セッション管理UI**
  - アクティブなtmuxウィンドウ一覧表示
  - ウィンドウ名の表示・変更
  - ウィンドウ間の切り替えボタン
- **履歴管理**
  - コマンド履歴の保存
  - よく使うコマンドのブックマーク
- **ファイル転送**
  - ドラッグ&ドロップでファイルアップロード
  - ダウンロード機能

## 3. 非機能要件

### 3.1 パフォーマンス
- ターミナル操作のレイテンシ: 100ms以内
- 日本語入力の応答性: IME変換が即座に反映
- 初回ロード時間: 3秒以内

### 3.2 互換性
- **ブラウザ対応**
  - iOS Safari 14以降
  - Android Chrome最新版
  - デスクトップChrome/Firefox/Safari最新版

### 3.3 セキュリティ
- トークン漏洩時のリスク最小化（IPアドレス制限オプション）
- HTTPS必須（Tailscale経由）
- XSS対策（入力サニタイズ）

### 3.4 保守性
- 標準的な技術スタックの使用
- ドキュメント整備
- 設定ファイルによるカスタマイズ可能

## 4. 技術制約

### 4.1 環境
- **サーバーサイド**: WSL2 Ubuntu
- **ネットワーク**: Tailscale VPN経由
  - **Tailscale構成**: Windows側にのみTailscaleをインストール（WSL2側には不要）
  - WSL2の自動ポートフォワーディングにより、WindowsのTailscale IP経由でWSL2にアクセス可能
  - `start.sh`がWindows側の`tailscale.exe`（`/mnt/c/Program Files/Tailscale/tailscale.exe`）を自動実行してIPアドレス取得
  - DNS競合の問題を完全回避（WSL2側のDNS自動生成とTailscaleのMagic DNSの競合を防ぐ）
- **ポート**:
  - フロントエンド: `3101`
  - バックエンド: `3102`
  - `80` / Nginx は前提にしない（ローカル運用は Next.js/Express をそのまま利用）

### 4.2 技術スタック候補（詳細は技術設計書で決定）

#### バックエンド
- **Webサーバー**:
  - Next.js（フロントのWebサーバとして使用）
  - Express.js（バックエンドHTTP/WebSocketのサーバとして使用）
- **SSH接続**: OpenSSH（ポート22）
- **WebSocket/SSE**: リアルタイム通信用

#### フロントエンド
- **フレームワーク**:
  - React + Next.js（エコシステムが充実、Claude Code on the Webも使用している可能性）
  - または Vue 3 + Nuxt（軽量でモダン）
- **ターミナルライブラリ**: xterm.js（CJK/IME完全サポート、実績豊富）
- **UIライブラリ**: Tailwind CSS（モダンなデザインが容易）

### 4.3 避けるべき技術
- カスタム実装のWebサーバー（標準的なものを使用）
- 実績の少ない新興フレームワーク
- 複雑すぎるアーキテクチャ

## 5. デザイン要求

### 5.1 全体イメージ
- **Claude Code on the Web風のクリーンなデザイン**
- **モダンで斬新な外観**
- **ダークモード優先**（ライトモードもオプションで）

### 5.2 配色イメージ
- ダーク系背景（#1a1a2e, #16213e等）
- アクセントカラー（Claude風のオレンジ系、または独自色）
- ターミナル背景: 黒またはダークグレー
- テキスト: 白またはライトグレー

### 5.3 レイアウト
- **メインエリア**: ターミナル表示（全画面の大部分）
- **コントロールパネル**: 画面下部または右側（展開/折りたたみ可能）
- **ヘッダー**: 最小限（接続状態、設定ボタン程度）
- **モバイルファースト**: タッチ操作を優先

## 6. スケジュール

### Phase 0: 要件定義・設計（本書）
- 要件定義書作成 ✓
- 技術設計書作成（次のステップ）
- 実装計画書作成（TDD準拠版）

### Phase 1: MVP開発
- バックエンド基本実装
- フロントエンド基本実装
- SSH接続・WebSocket通信
- 基本的なターミナル機能

### Phase 2: 日本語入力・UI改善
- IME完全対応
- コントロールパネル実装
- デザイン洗練



### 7.2 機能仕様
- [x] トークンの更新方法（起動ごとランダム + ワンタイム共有リンクでカバー）
- [x] 複数デバイスからの同時接続（セッション共有で対応）
- [x] セッション切断時の自動再接続機能（実装済み）
- [ ] ファイル転送機能の優先度（Phase 2以降）

### 7.3 デザイン詳細
- [x] 具体的な配色（Claude風ダークテーマ）
- [x] アイコンセット（独自SVG + Unicode）
- [x] アニメーション効果（Tailwind transition）

## 8. リスクと対策

### 8.1 技術的リスク
- **リスク**: SSH over WebSocketの実装難易度
  - **対策**: 既存ライブラリ（ssh2, node-pty等）の活用、段階的実装
- **リスク**: IME対応の不具合
  - **対策**: xterm.jsの実績を活用、早期テスト

### 8.2 セキュリティリスク
- **リスク**: トークン漏洩
  - **対策**: Tailscale VPN内限定、IPアドレス制限オプション
- **リスク**: SSH認証の安全性
  - **対策**: 鍵認証必須、パスワード認証無効化

## 9. 参考資料

- **Claude Code on the Web**: チャッピーの調査結果
- **Nagi Terminal**: 既存システム（参考実装）
- **xterm.js公式ドキュメント**: https://xtermjs.org/
- **Tailscale公式ドキュメント**: https://tailscale.com/kb/

---

## 次のステップ

1. **技術設計書の作成**: 上記の技術スタック候補から具体的な選択を行い、アーキテクチャを設計
2. **あおいさんへの確認**: 未確定事項の決定
3. **実装計画書（TDD準拠版）**: 具体的なタスクリストとマイルストーン設定
